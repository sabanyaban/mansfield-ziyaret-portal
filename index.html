<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mansfield Ziyaret PortalÄ±</title>

<!-- KÃ¼tÃ¼phaneler -->
<script src=https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js></script>
<script src=https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#475569; --border:#d6dee9;
    --accent:#0f766e; --accent2:#1e3a8a; --hover:#eef2f7; --input:#f8fafc; --focus:#93c5fd;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.1) blur(8px);background:rgba(255,255,255,.9);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;align-items:center}
  .between{justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px;color:var(--accent2)}
  #brandLogo{width:32px;height:32px;object-fit:contain;border-radius:6px;display:none}
  .logo-fallback{width:32px;height:32px;border-radius:6px;background:linear-gradient(135deg,var(--accent2),var(--accent))}
  button{cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 12px;border-radius:10px;font-weight:600;transition:all .15s}
  button:hover{background:#e8f3ff;border-color:#c7d8f2;transform:translateY(-1px)}
  button:active{transform:translateY(0)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;padding:16px}
  .card{grid-column:span 12;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 4px rgba(15,23,42,.06)}
  @media(min-width:1000px){.span4{grid-column:span 4}.span8{grid-column:span 8}.span12{grid-column:span 12}}
  h2{margin:0 0 10px;font-size:18px;color:var(--accent2)}
  h3{margin:10px 0 6px;font-size:14px;color:var(--muted);font-weight:700;letter-spacing:.2px}
  input,select,textarea{width:100%;background:var(--input);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:10px;outline:none;transition:border-color .15s,box-shadow .15s}
  input::placeholder,textarea::placeholder{color:#94a3b8}
  input:focus,select:focus,textarea:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(147,197,253,.35)}
  .muted{color:var(--muted);font-size:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#e7f3ff;color:var(--accent2)}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{text-align:left;padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:top}
  .table tbody tr{transition:background-color .12s}
  .table tbody tr:hover{background:var(--hover)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#ecfeff;color:#075985}
  .chip button{border:none;background:transparent;color:var(--muted);cursor:pointer}
  .flexwrap{display:flex;gap:10px;flex-wrap:wrap}
  .grow{flex:1 1 200px}
  .pill{padding:.2rem .55rem;border:1px solid var(--border);border-radius:999px;font-size:12px;display:inline-block;background:#f0fbf7;color:var(--accent)}
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.35);display:none;place-items:center;z-index:60}
  .modal .box{width:min(92vw,680px);background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 8px 24px rgba(2,6,23,.2)}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:16px}
  .vbadge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#eef6ff;color:#1e3a8a;font-size:12px;margin-left:6px}
</style>
</head>
<body>
  <!-- Basit giriÅŸ -->
  <div id="gate" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(245,247,251,.9);z-index:50;">
    <div style="width:min(92vw,480px);background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 6px 18px rgba(2,6,23,.08)">
      <div class="row" style="justify-content:center;margin-bottom:8px">
        <span class="logo-fallback"></span>
        <div style="font-weight:900;font-size:18px;color:var(--accent2)">Mansfield Ziyaret PortalÄ±</div>
      </div>
      <p class="muted" style="margin-top:0">EriÅŸim iÃ§in ÅŸifre girin. <strong>Not:</strong> Bu yalnÄ±zca gÃ¶rÃ¼nÃ¼rlÃ¼k kalkanÄ±dÄ±r.</p>
      <label for="pw" class="muted">Åžifre</label>
      <input id="pw" type="password" placeholder="Ã¶rn. 12345" autocomplete="current-password"/>
      <div id="pwErr" style="display:none;color:#dc2626;font-size:12px;margin-top:6px">Åžifre hatalÄ±.</div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="loginBtn" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;border-color:transparent">GiriÅŸ</button>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap row between">
      <div class="brand">
        <img id="brandLogo" alt="Mansfield"/>
        <span id="brandFallback" class="logo-fallback"></span>
        <span>Mansfield Ziyaret PortalÄ±</span>
      </div>
      <div class="controls row">
        <span class="badge" id="clock">--:--</span>
        <button id="printBtn">YazdÄ±r</button>
        <button id="exportBtn">XLSX DÄ±ÅŸa Aktar</button>
        <label class="row" style="gap:8px"><input type="checkbox" id="adminToggle"/> <span>Admin modu</span></label>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Filtreler -->
      <section class="card span12">
        <h2>HÄ±zlÄ± Filtre</h2>
        <div class="flexwrap">
          <input id="q" class="grow" placeholder="MÃ¼ÅŸteri adÄ± / not ara"/>
          <select id="fMode" class="grow">
            <option value="">TaÅŸÄ±ma modu (hepsi)</option>
            <option value="Sea">Deniz</option>
            <option value="Road">Kara</option>
            <option value="Air">Hava</option>
          </select>
          <select id="fStatus" class="grow">
            <option value="">Durum (hepsi)</option>
            <option>Yeni</option><option>SÄ±cak</option><option>Teklif GÃ¶nderildi</option>
            <option>Beklemede</option><option>KazanÄ±ldÄ±</option><option>Kaybedildi</option>
          </select>
          <input id="fPort" class="grow" placeholder="Liman filtrele (Ã¶rn. Mersin, Hamburg)"/>
          <input id="fMinVol" class="grow" placeholder="Min yÄ±llÄ±k hacim" type="number" min="0"/>
          <input id="fFrom" class="grow" type="date"/>
          <input id="fTo" class="grow" type="date"/>
          <button id="clearFilters">Filtreleri Temizle</button>
        </div>
      </section>

      <!-- Ziyaret Ekle -->
      <section class="card span8">
        <h2>Yeni MÃ¼ÅŸteri Ziyareti</h2>
        <div class="flexwrap">
          <input id="cName" class="grow" placeholder="MÃ¼ÅŸteri adÄ± *"/>
          <input id="cContact" class="grow" placeholder="Yetkili kiÅŸi"/>
          <input id="cPhone" class="grow" placeholder="Telefon / e-posta"/>
        </div>

        <div class="flexwrap">
          <div class="grow">
            <h3>TaÅŸÄ±ma Modu</h3>
            <div class="row" style="flex-wrap:wrap;gap:12px">
              <label><input type="checkbox" class="mode" value="Sea"> Deniz</label>
              <label><input type="checkbox" class="mode" value="Road"> Kara</label>
              <label><input type="checkbox" class="mode" value="Air"> Hava</label>
            </div>
          </div>
          <div class="grow">
            <h3>Durum</h3>
            <select id="cStatus">
              <option>Yeni</option><option>SÄ±cak</option><option>Teklif GÃ¶nderildi</option>
              <option>Beklemede</option><option>KazanÄ±ldÄ±</option><option>Kaybedildi</option>
            </select>
          </div>
          <div class="grow">
            <h3>Ã–ncelik</h3>
            <select id="cPriority">
              <option>Normal</option><option>YÃ¼ksek</option><option>DÃ¼ÅŸÃ¼k</option>
            </select>
          </div>
        </div>

        <!-- POL/POD -->
        <div class="flexwrap">
          <div class="grow">
            <h3>POL (YÃ¼kleme LimanÄ±)</h3>
            <input id="polSearch" placeholder="Ara... (Ã¶rn. MERSIN)"/>
            <select id="polSelect" size="8" multiple style="margin-top:6px"></select>
            <div class="row" style="gap:6px;margin-top:6px">
              <button id="polAll" type="button">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
              <button id="polClear" type="button">Temizle</button>
            </div>
          </div>
          <div class="grow">
            <h3>POD (VarÄ±ÅŸ LimanÄ±)</h3>
            <input id="podSearch" placeholder="Ara... (Ã¶rn. HAMBURG)"/>
            <select id="podSelect" size="8" multiple style="margin-top:6px"></select>
            <div class="row" style="gap:6px;margin-top:6px">
              <button id="podAll" type="button">TÃ¼mÃ¼nÃ¼ SeÃ§</button>
              <button id="podClear" type="button">Temizle</button>
            </div>
          </div>
          <div class="grow" style="min-width:220px">
            <h3>Rota</h3>
            <div class="muted">Ã‡oklu seÃ§im (Ctrl/Cmd/Shift). <strong>POL â†’ POD</strong> ekle.</div>
            <button id="addRoute" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;border-color:transparent;margin-top:6px">
              POL â†’ POD ekle
            </button>
          </div>
        </div>

        <div class="flexwrap">
          <div class="grow">
            <h3>Limanlar</h3>
            <input id="portInput" placeholder="Serbest giriÅŸ: Liman yaz ve Enter"/>
            <div id="portChips"></div>
          </div>
          <div class="grow">
            <h3>YÄ±llÄ±k Hacim</h3>
            <div class="row" style="gap:8px">
              <input id="cVolume" type="number" min="0" placeholder="miktar"/>
              <select id="cVolUnit">
                <option>TEU</option><option>Sefer</option><option>Ton</option>
              </select>
            </div>
            <label class="row" style="gap:8px;margin-top:8px">
              <input id="needQuote" type="checkbox"> Teklif gerektiriyor
            </label>
          </div>
        </div>

        <div class="flexwrap">
          <div class="grow">
            <h3>Ziyaret Tarihi</h3>
            <input id="cVisit" type="date"/>
          </div>
          <div class="grow">
            <h3>Takip Tarihi</h3>
            <input id="cFollow" type="date"/>
          </div>
          <div class="grow">
            <h3>Etiketler</h3>
            <input id="tagInput" placeholder="Etiket yaz ve Enter"/>
            <div id="tagChips"></div>
          </div>
        </div>
        <h3>Notlar</h3>
        <textarea id="cNotes" rows="5" placeholder="Ziyaret notlarÄ±, rakipler, transit, ekipman vb."></textarea>
        <div class="row" style="justify-content:flex-end;gap:8px;margin-top:10px">
          <button id="vReset">Temizle</button>
          <button id="vSave" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;border-color:transparent">Kaydet</button>
        </div>
      </section>

      <!-- SaÄŸ panel -->
      <section class="card span4">
        <h2>HÄ±zlÄ± BaÄŸlantÄ±lar</h2>
        <ul id="linkList" style="list-style:none;padding:0;margin:0"></ul>
        <div id="linkEdit" style="display:none;margin-top:10px">
          <input id="linkText" placeholder="GÃ¶rÃ¼nen ad"/>
          <input id="linkUrl" placeholder=https://â€¦/>
          <div class="row" style="justify-content:flex-end;margin-top:8px">
            <button id="linkSave" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;border-color:transparent">Ekle</button>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:6px">
          <button id="linkAdd" style="display:none">+ BaÄŸlantÄ±</button>
        </div>

        <h3 style="margin-top:14px">MÃ¼ÅŸteri NotlarÄ±</h3>
        <ul id="customerLinks" style="list-style:none;padding:0;margin:0"></ul>
        <p class="muted" style="margin-top:8px">Ä°sme tÄ±klayÄ±nca notu <strong>PDF</strong> olarak gÃ¶rÃ¼ntÃ¼ler.</p>

        <div id="logoAdmin" style="display:none;margin-top:14px">
          <h3>Logo</h3>
          <input type="file" id="logoFile" accept="image/*"/>
          <p class="muted">Logo seÃ§ â†’ otomatik kaydedilir (yalnÄ±z bu cihaz). PDFâ€™lere basÄ±lÄ±r.</p>

          <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)">

          <h3>POL / POD YÃ¶netimi</h3>
          <p class="muted">Her satÄ±ra bir liman yazÄ±n. Kaydet sonrasÄ± seÃ§im listeleri gÃ¼ncellenir.</p>
          <h4>POL Listesi</h4>
          <textarea id="polAdmin" rows="5" style="width:100%;"></textarea>
          <h4>POD Listesi</h4>
          <textarea id="podAdmin" rows="7" style="width:100%;"></textarea>
          <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
            <button id="polpodSave">Kaydet</button>
            <button id="polpodReset">VarsayÄ±lana DÃ¶n</button>
          </div>
        </div>
      </section>

      <!-- Liste -->
      <section class="card span12">
        <h2>MÃ¼ÅŸteri Ziyaretleri</h2>
        <table class="table" id="visitTable">
          <thead>
            <tr>
              <th>No</th>
              <th>Tarih</th>
              <th>MÃ¼ÅŸteri</th>
              <th>Mod</th>
              <th>Limanlar</th>
              <th>Hacim</th>
              <th>Durum</th>
              <th>Takip</th>
              <th>GÃ¼ncelleme</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="muted">KayÄ±tlar bu cihazda saklanÄ±r (localStorage). XLSX/Excel XML ile dÄ±ÅŸa aktarabilirsiniz.</p>
      </section>
    </div>
    <div class="footer">Â© <span id="year"></span> Mansfield â€” Ziyaret PortalÄ± (Yerel kullanÄ±m)</div>
  </main>

  <!-- Not gÃ¼ncelleme modalÄ± -->
  <div id="editModal" class="modal">
    <div class="box">
      <h2>Notu GÃ¼ncelle</h2>
      <textarea id="editNotes" rows="8" style="width:100%"></textarea>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="editCancel">VazgeÃ§</button>
        <button id="editSave" style="background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;border-color:transparent">Kaydet</button>
      </div>
    </div>
  </div>

<script>

  // ====== Supabase baÄŸlantÄ±sÄ± ======
  const SUPABASE_URL = 'https://grqklcgxwmboedacobld.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdycWtsY2d4d21ib2VkYWNvYmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjc0NTUsImV4cCI6MjA3ODYwMzQ1NX0.8kUPsW6OtEZb-Dj0V83c0FcbhNyCnrbEZ3g6b_0dseo'; // anon public key
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ====== Temel ayarlar ======
  const PASSWORD='12345';
  const STORAGE={
    visits:'intra.visits',
    links:'intra.links',
    session:'intra.session',
    admin:'intra.admin',
    logo:'intra.logo',
    pol:'intra.pol',
    pod:'intra.pod'
  };

  // ---- YardÄ±mcÄ±lar (EN ÃœSTE ALINDI) ----
  const $=(s,root=document)=>root.querySelector(s);
  const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const load=(k,f)=>{ try{return JSON.parse(localStorage.getItem(k)) ?? f;}catch{return f;} };
  const niceDate=d=> d? new Date(d).toLocaleDateString('tr-TR'):'';
  function sanitizeNotes(s){
    return String(s||'')
      .replace(/\u00A0/g,' ')
      .replace(/\r\n?/g,'\n')
      .replace(/[\u200B-\u200D\uFEFF]/g,'')
      .normalize('NFC');
  }

  // VarsayÄ±lan POL (Aâ†’Z)
  const DEFAULT_POL_LIST=['AMBARLI','ANTALYA','ASYAPORT','DERINCE','GEMLÄ°K','ISKENDERUN','IZMIR','MERSIN','TRABZON']
    .sort((a,b)=>a.localeCompare(b,'tr-TR'));

  // VarsayÄ±lan POD listesi
  const DEFAULT_POD_LIST=(function(){
    const raw=[
      'ABIDJAN','AQABA','AJMAN','ALTAMIRA','AMBARLI','ANTWERP','BUSAN','CALLAO','CARTAGENA','CASABLANCA','CAUCEDO',
      'CHITTAGONG','DJIBOUTI','DURBAN','FELIXSTOWE','FOS SUR MER','GEBZE','GEMLIK','GUAYAQUIL','HAMAD','HAMBURG',
      'HAIPHONG','HONG KONG','HOUSTON','ISKENDERUN','ITAPOA','IZMIR','JAKARTA','JEBEL ALI','JEDDAH','KAOHSIUNG',
      'KARACHI','KOPER','LAEM CHABANG','LEIXOES','LUANDA','MANILA','MANAUS','MANZANILLO','MERSIN','MISURATA',
      'MUNDRA','NEW YORK','NHAVA SHEVA','ORAN','PARANAGUA','PIRAEUS','POINTE NOIRE','PORT EVERGLADES','PORT KELANG',
      'QINGDAO','RAVENNA','RIO DE JANEIRO','RIO GRANDE','SALALAH','SALERNO','SALVADOR','SAN ANTONIO','SANTA MARTA',
      'SANTOS','SAVANNAH','SHANGHAI','SHARJAH','SHUAIBA','SINGAPORE','SOHAR','SUAPE','TAICHUNG','TERNEUZEN',
      'TIANJIN XINGANG','UMM QASR','VERACRUZ','VITORIA','XIAMEN','ZHANGJIAGANG'
    ];
    return Array.from(new Set(raw)).sort((a,b)=>a.localeCompare(b,'tr-TR'));
  })();

  // LocalStorage'dan okunan gÃ¼ncel listeler
  let polList = load(STORAGE.pol,null) || DEFAULT_POL_LIST.slice();
  let podList = load(STORAGE.pod,null) || DEFAULT_POD_LIST.slice();

  // === ID Ã¼retimi (MAF0001) ve meta dÃ¼zeltme ===
  function nextId(list){
    const max = (list||[]).reduce((m,v)=>{
      const n = String(v?.id||'').match(/^MAF(\d{4})$/)?.[1];
      return Math.max(m, n?Number(n):0);
    },0);
    const num = max+1;
    return 'MAF'+String(num).padStart(4,'0');
  }

  function ensureVisitMeta(){
    const list=load(STORAGE.visits,[]);
    let changed=false;
    const currentMax = (list||[]).reduce((m,v)=>{
      const n = String(v?.id||'').match(/^MAF(\d{4})$/)?.[1];
      return Math.max(m, n?Number(n):0);
    },0);
    let counter=currentMax;
    list.forEach(v=>{
      if(!v.id){ counter+=1; v.id='MAF'+String(counter).padStart(4,'0'); changed=true; }
      if(typeof v.ver!=='number'){ v.ver=1; changed=true; }
      if(!('baseNote' in v)){
        v.baseNote = v.notes || '';
        changed = true;
      }
      if(!('updateNote' in v)){
        v.updateNote = '';
        changed = true;
      }
    });
    if(changed) save(STORAGE.visits,list);
    return list;
  }

  // ====== GiriÅŸ ======
  const gate=$('#gate'), loginBtn=$('#loginBtn'), pw=$('#pw'), pwErr=$('#pwErr');
  function allow(){ gate.style.display='none'; sessionStorage.setItem(STORAGE.session,'ok'); }
  loginBtn.addEventListener('click',()=>{ if(pw.value===PASSWORD){allow();} else {pwErr.style.display='block'; pw.select();} });
  pw.addEventListener('keypress',e=>{ if(e.key==='Enter') loginBtn.click(); });
  if(sessionStorage.getItem(STORAGE.session)==='ok'){ gate.style.display='none'; }

  // ====== Saat & YazdÄ±r ======
  const clock=$('#clock');
  function tick(){ clock.textContent=new Date().toLocaleString('tr-TR',{dateStyle:'medium',timeStyle:'short'}); }
  setInterval(tick,1000); tick();
  $('#printBtn').addEventListener('click',()=>window.print());

  // ====== Admin modu + Logo + POL/POD admin ======
  const adminToggle=$('#adminToggle');
  function setBrandLogo(src){
    const img=$('#brandLogo'), fb=$('#brandFallback');
    if(src){ img.src=src; img.style.display='inline-block'; fb.style.display='none'; }
    else{ img.removeAttribute('src'); img.style.display='none'; fb.style.display='inline-block'; }
  }
  setBrandLogo(load(STORAGE.logo,'')||null);

  function renderPolPodAdmin(){
    const polArea=$('#polAdmin');
    const podArea=$('#podAdmin');
    if(!polArea || !podArea) return;
    polArea.value = (polList||[]).join('\n');
    podArea.value = (podList||[]).join('\n');
  }

  function setAdmin(on){
    adminToggle.checked=!!on; save(STORAGE.admin,!!on);
    $('#linkAdd').style.display=on?'inline-block':'none';
    $('#linkEdit').style.display='none';
    $('#logoAdmin').style.display=on?'block':'none';
    if(on){ renderPolPodAdmin(); }
  }
  adminToggle.addEventListener('change',e=> setAdmin(e.target.checked));
  setAdmin(load(STORAGE.admin,false));

  const logoFileEl=$('#logoFile');
  if(logoFileEl){
    logoFileEl.addEventListener('change',e=>{
      const f=e.target.files?.[0]; if(!f) return;
      const rd=new FileReader();
      rd.onload=()=>{ save(STORAGE.logo,rd.result); setBrandLogo(rd.result); alert('Logo kaydedildi.'); };
      rd.readAsDataURL(f);
    });
  }

  // POL/POD admin kayÄ±t
  $('#polpodSave')?.addEventListener('click',()=>{
    const polArea=$('#polAdmin');
    const podArea=$('#podAdmin');
    if(!polArea || !podArea) return;
    const polLines = polArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
    const podLines = podArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
    polList = Array.from(new Set(polLines)).sort((a,b)=>a.localeCompare(b,'tr-TR'));
    podList = Array.from(new Set(podLines)).sort((a,b)=>a.localeCompare(b,'tr-TR'));
    save(STORAGE.pol,polList);
    save(STORAGE.pod,podList);
    filterAndFill(polSelect,polList,polSearch.value);
    filterAndFill(podSelect,podList,podSearch.value);
    alert('POL/POD listeleri gÃ¼ncellendi.');
  });

  $('#polpodReset')?.addEventListener('click',()=>{
    polList = DEFAULT_POL_LIST.slice();
    podList = DEFAULT_POD_LIST.slice();
    save(STORAGE.pol,polList);
    save(STORAGE.pod,podList);
    renderPolPodAdmin();
    filterAndFill(polSelect,polList,polSearch.value);
    filterAndFill(podSelect,podList,podSearch.value);
    alert('VarsayÄ±lan POL/POD listesine dÃ¶nÃ¼ldÃ¼.');
  });

  // ====== HÄ±zlÄ± baÄŸlantÄ±lar ======
  const linkListEl=$('#linkList');
  function renderLinks(){
    const links=load(STORAGE.links,[
      {text:'Outlook',url:'https://outlook.office.com'},
      {text:'CMA CGM eBusiness',url:'https://www.cma-cgm.com/eBusiness'},
      {text:'Maersk',url:'https://www.maersk.com/'}
    ]);
    linkListEl.innerHTML='';
    links.forEach((l,i)=>{
      const li=document.createElement('li');
      li.style.display='flex';
      li.style.justifyContent='space-between';
      li.style.padding='8px 0';
      li.style.borderBottom='1px dashed var(--border)';
      li.innerHTML=
        `<a class="link" target="_blank" rel="noopener" href="${l.url}">${l.text}</a>
         <div style="${adminToggle.checked?'':'display:none'}">
           <button class="linkEditBtn" data-i="${i}">DÃ¼zenle</button>
           <button class="linkDelBtn" data-i="${i}">Sil</button>
         </div>`;
      linkListEl.appendChild(li);
    });
  }
  renderLinks();

  $('#linkAdd').addEventListener('click',()=>{
    $('#linkEdit').style.display='block';
    $('#linkText').value='';
    $('#linkUrl').value='';
    $('#linkText').focus();
    $('#linkSave').onclick=()=>{
      const links=load(STORAGE.links,[]);
      links.push({text:$('#linkText').value||'BaÄŸlantÄ±',url:$('#linkUrl').value||'#'});
      save(STORAGE.links,links);
      $('#linkEdit').style.display='none';
      renderLinks();
    };
  });

  linkListEl.addEventListener('click',e=>{
    const i=e.target.dataset?.i; if(i==null) return;
    const links=load(STORAGE.links,[]);
    if(e.target.classList.contains('linkDelBtn')){
      links.splice(i,1); save(STORAGE.links,links); renderLinks();
    } else if(e.target.classList.contains('linkEditBtn')){
      $('#linkEdit').style.display='block';
      $('#linkText').value=links[i].text;
      $('#linkUrl').value=links[i].url;
      $('#linkSave').onclick=()=>{
        links[i].text=$('#linkText').value;
        links[i].url=$('#linkUrl').value;
        save(STORAGE.links,links);
        $('#linkEdit').style.display='none';
        renderLinks();
      };
    }
  });

  // ====== Chips ======
  function setupChips(inputEl, chipsEl){
    const arr=[];
    function render(){
      chipsEl.innerHTML='';
      arr.forEach((t,idx)=>{
        const c=document.createElement('span');
        c.className='chip';
        c.innerHTML=`${t} <button data-i="${idx}" title="Sil">âœ•</button>`;
        chipsEl.appendChild(c);
      });
    }
    inputEl.addEventListener('keypress',e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const v=inputEl.value.trim();
        if(v && !arr.includes(v)){ arr.push(v); render(); }
        inputEl.value='';
      }
    });
    chipsEl.addEventListener('click',e=>{
      const i=e.target.dataset?.i; if(i==null) return;
      arr.splice(+i,1);
      render();
    });
    return {
      get:()=>arr.slice(),
      set:(a)=>{
        a=a||[];
        arr.splice(0,arr.length);
        a.forEach(x=>arr.push(x));
        render();
      }
    };
  }
  const portChip=setupChips($('#portInput'),$('#portChips'));
  const tagChip=setupChips($('#tagInput'),$('#tagChips'));

  // ====== POL/POD doldurma ======
  const polSelect=$('#polSelect'), polSearch=$('#polSearch');
  const podSelect=$('#podSelect'), podSearch=$('#podSearch');
  function fillOptions(sel,items){
    sel.innerHTML='';
    items.forEach(v=>{
      const o=document.createElement('option');
      o.textContent=v;
      sel.appendChild(o);
    });
  }
  function normalize(s){ return String(s||'').toLocaleUpperCase('tr-TR'); }
  function filterAndFill(sel,items,q){
    const qq=normalize(q).trim();
    const out=qq? items.filter(x=>normalize(x).includes(qq)) : items;
    fillOptions(sel,out);
    if(out.length) sel.selectedIndex=0;
  }
  filterAndFill(polSelect, polList, '');
  filterAndFill(podSelect, podList, '');
  polSearch.addEventListener('input',()=> filterAndFill(polSelect,polList,polSearch.value));
  podSearch.addEventListener('input',()=> filterAndFill(podSelect,podList,podSearch.value));

  $('#polAll').addEventListener('click',()=>{
    Array.from(polSelect.options).forEach(o=>o.selected=true);
    polSelect.focus();
  });
  $('#polClear').addEventListener('click',()=>{
    Array.from(polSelect.options).forEach(o=>o.selected=false);
    polSearch.value='';
    filterAndFill(polSelect,polList,'');
    polSelect.focus();
  });
  $('#podAll').addEventListener('click',()=>{
    Array.from(podSelect.options).forEach(o=>o.selected=true);
    podSelect.focus();
  });
  $('#podClear').addEventListener('click',()=>{
    Array.from(podSelect.options).forEach(o=>o.selected=false);
    podSearch.value='';
    filterAndFill(podSelect,podList,'');
    podSelect.focus();
  });
  $('#addRoute').addEventListener('click',()=>{
    const selPol=Array.from(polSelect.selectedOptions).map(o=>o.value).filter(Boolean);
    const selPod=Array.from(podSelect.selectedOptions).map(o=>o.value).filter(Boolean);
    const fallbackPol=polSearch.value.trim()? [polSearch.value.trim()] : [];
    const fallbackPod=podSearch.value.trim()? [podSearch.value.trim()] : [];
    const pols=selPol.length? selPol : fallbackPol;
    const pods=selPod.length? selPod : fallbackPod;
    if(!pols.length || !pods.length){
      alert('POL ve POD seÃ§iniz ya da yazÄ±nÄ±z.');
      return;
    }
    const cur=new Set(portChip.get());
    pols.forEach(p=> pods.forEach(d=> cur.add(`${p}â†’${d}`)));
    portChip.set(Array.from(cur));
  });

  // ====== KayÄ±tlar ======
  const visitTable=$('#visitTable tbody');
  function getModes(){ return $$('.mode').filter(x=>x.checked).map(x=>x.value); }

  function clearForm(){
    $('#cName').value='';
    $('#cContact').value='';
    $('#cPhone').value='';
    $$('.mode').forEach(x=>x.checked=false);
    $('#cStatus').value='Yeni';
    $('#cPriority').value='Normal';
    portChip.set([]);
    $('#cVolume').value='';
    $('#cVolUnit').value='TEU';
    $('#needQuote').checked=false;
    $('#cVisit').value='';
    $('#cFollow').value='';
    tagChip.set([]);
    $('#cNotes').value='';
    polSearch.value='';
    podSearch.value='';
    filterAndFill(polSelect,polList,'');
    filterAndFill(podSelect,podList,'');
  }

  function renderCustomerLinks(){
    const list=ensureVisitMeta();
    const latestByName={};
    list.forEach(v=>{ if(!latestByName[v.name]) latestByName[v.name]=v; });
    const names=Object.keys(latestByName).sort((a,b)=>a.localeCompare(b,'tr-TR'));
    const ul=$('#customerLinks');
    ul.innerHTML='';
    names.forEach(n=>{
      const li=document.createElement('li');
      li.style.display='flex';
      li.style.justifyContent='space-between';
      li.style.padding='6px 0';
      li.style.borderBottom='1px dashed var(--border)';
      const a=document.createElement('a');
      a.href='#';
      a.textContent=n;
      a.addEventListener('click',ev=>{
        ev.preventDefault();
        showVisitPDF(latestByName[n]);
      });
      li.appendChild(a);
      ul.appendChild(li);
    });
  }

async function saveVisit(v) {
  const list = ensureVisitMeta();
  v.id = nextId(list);
  v.ver = 1;
  v.baseNote = v.notes || '';
  v.updateNote = v.updateNote || '';
  const newList = [v, ...list];
  save(STORAGE.visits, newList);
  renderVisits();
  renderCustomerLinks();
  clearForm();

  // --- Supabase'e de gÃ¶nder ---
  try {
    const { error } = await supabase.from('visits').insert([{
      name: v.name,
      contact: v.contact,
      phone: v.phone,
      modes: v.modes,
      status: v.status,
      priority: v.priority,
      ports: v.ports,
      volume: v.volume,
      vol_unit: v.volUnit,
      visit_date: v.visitDate,
      follow_date: v.followDate,
      notes: v.notes
    }]);
    if (error) console.error("Supabase insert hatasÄ±:", error);
    else console.log("KayÄ±t Supabase'e eklendi:", v.name);
  } catch (err) {
    console.error("BaÄŸlantÄ± hatasÄ±:", err);
  }
}


  function renderVisits(){
    const list=ensureVisitMeta();
    const q=$('#q').value.trim().toLowerCase();
    const fMode=$('#fMode').value;
    const fStatus=$('#fStatus').value;
    const fPort=$('#fPort').value.trim().toLowerCase();
    const fMinVol=Number($('#fMinVol').value||0);
    const fFrom=$('#fFrom').value?new Date($('#fFrom').value):null;
    const fTo=$('#fTo').value?new Date($('#fTo').value):null;

    const filt=list.filter(it=>{
      if(q && !(String(it.name||'').toLowerCase().includes(q) || String(it.baseNote||it.notes||'').toLowerCase().includes(q))) return false;
      if(fMode && !(it.modes||[]).includes(fMode)) return false;
      if(fStatus && it.status!==fStatus) return false;
      if(fPort){
        const ports=(it.ports||[]).join(',').toLowerCase();
        if(!ports.includes(fPort)) return false;
      }
      const vol=Number(it.volume||0);
      if(fMinVol && !(vol>=fMinVol)) return false;
      const vd=it.visitDate?new Date(it.visitDate):null;
      if(fFrom && vd && vd<fFrom) return false;
      if(fTo && vd && vd>fTo) return false;
      return true;
    });

    visitTable.innerHTML='';
    filt.forEach((v,idx)=>{
      const tr=document.createElement('tr');
      const mod=(v.modes||[]).join('/');
      const ports=(v.ports||[]).join(' Â· ');
      const vol=v.volume?(v.volume+' '+(v.volUnit||'')):'';
      const follow=v.followDate?niceDate(v.followDate):'';
      const upd=v.updatedAt?niceDate(v.updatedAt):'';
      tr.innerHTML=
        `<td><strong>${v.id||''}</strong></td>
         <td><span class="pill">${niceDate(v.visitDate)}</span></td>
         <td><strong>${v.name||''}</strong><div class="muted">${v.contact||''}${v.phone?' Â· '+v.phone:''}</div></td>
         <td>${mod}</td>
         <td>${ports}</td>
         <td>${vol}</td>
         <td>${v.status||''}${v.priority==='YÃ¼ksek'?' ðŸ”¥':''}</td>
         <td>${follow}</td>
         <td>${upd}${typeof v.ver==='number' ? ` <span class="vbadge">v${v.ver}</span>`:''}</td>
         <td>
           <button class="rowToggle" data-i="${idx}">Detay</button>
           <button class="edit" data-i="${idx}">GÃ¼ncelle</button>
           <button class="pdf" data-i="${idx}">PDF</button>
           <button class="del" data-i="${idx}">Sil</button>
         </td>`;
      visitTable.appendChild(tr);

      const tr2=document.createElement('tr');
      const baseHtml = sanitizeNotes(v.baseNote ?? v.notes ?? '').replace(/\n/g,'<br>');
      let notesHtml = baseHtml || '<span class="muted">Not yok</span>';
      if(v.updateNote){
        const updDate = v.updatedAt ? new Date(v.updatedAt).toLocaleDateString('tr-TR') : '';
        const updHtml  = sanitizeNotes(v.updateNote).replace(/\n/g,'<br>');
        notesHtml += `<br><br><strong>GÃ¼ncelleme Tarihi: ${updDate}</strong><br>${updHtml}`;
      }
      tr2.innerHTML=
        `<td colspan="10">
           <div class="muted">Etiketler: ${(v.tags||[]).join(', ')||'-'}</div>
           <div style="margin-top:6px">${notesHtml}</div>
         </td>`;
      tr2.style.display='none';
      visitTable.appendChild(tr2);
    });
  }

  // tablo aksiyonlarÄ±
  visitTable.addEventListener('click',e=>{
    const i=e.target.dataset?.i; if(i==null) return;
    const list=ensureVisitMeta();
    if(e.target.classList.contains('del')){
      list.splice(i,1);
      save(STORAGE.visits,list);
      renderVisits();
      renderCustomerLinks();
      return;
    }
    if(e.target.classList.contains('rowToggle')){
      const row=e.target.closest('tr');
      const next=row.nextElementSibling;
      if(next) next.style.display=(next.style.display==='none')?'table-row':'none';
      return;
    }
    if(e.target.classList.contains('edit')){
      openEditModal(i);
      return;
    }
    if(e.target.classList.contains('pdf')){
      showVisitPDF(list[i]);
      return;
    }
  });

  // Filtre olaylarÄ±
  ['q','fMode','fStatus','fPort','fMinVol','fFrom','fTo'].forEach(id=>{
    $('#'+id).addEventListener('input',renderVisits);
  });
  $('#clearFilters').addEventListener('click',()=>{
    ['q','fMode','fStatus','fPort','fMinVol','fFrom','fTo'].forEach(id=> $('#'+id).value='');
    renderVisits();
  });

  // Kaydet (yeni kayÄ±t)
  $('#vSave').addEventListener('click',()=>{
    const base = $('#cNotes').value.trim();
    const v={
      at:new Date().toISOString(),
      name:$('#cName').value.trim(),
      contact:$('#cContact').value.trim(),
      phone:$('#cPhone').value.trim(),
      modes:getModes(),
      status:$('#cStatus').value,
      priority:$('#cPriority').value,
      ports:portChip.get(),
      volume:$('#cVolume').value?Number($('#cVolume').value):'',
      volUnit:$('#cVolUnit').value,
      needQuote:$('#needQuote').checked,
      visitDate:$('#cVisit').value||new Date().toISOString(),
      followDate:$('#cFollow').value,
      tags:tagChip.get(),
      notes:base,
      baseNote:base,
      updateNote:'',
      updatedAt:''
    };
    if(!v.name){
      alert('MÃ¼ÅŸteri adÄ± zorunludur.');
      return;
    }
    saveVisit(v);
  });
  $('#vReset').addEventListener('click',clearForm);

  // Not gÃ¼ncelleme
  let editIndex=null, editModal=$('#editModal'), editNotes=$('#editNotes');
  function openEditModal(i){
    editIndex=i;
    ensureVisitMeta();
    editNotes.value='';
    editModal.style.display='grid';
  }
  $('#editCancel').addEventListener('click',()=>{
    editModal.style.display='none';
    editIndex=null;
  });
  $('#editSave').addEventListener('click',()=>{
    const list=ensureVisitMeta();
    if(editIndex==null || !list[editIndex]) return;
    const v=list[editIndex];
    const newUpdate = editNotes.value.trim();
    if(!v.baseNote){
      v.baseNote = v.notes || '';
    }
    if(newUpdate){
      v.updateNote = newUpdate;
    }
    v.ver = (typeof v.ver==='number' ? v.ver : 1) + 1;
    v.updatedAt = new Date().toISOString();
    save(STORAGE.visits,list);
    editModal.style.display='none';
    editIndex=null;
    renderVisits();
    renderCustomerLinks();
  });
  editModal.addEventListener('click',e=>{
    if(e.target===editModal){ editModal.style.display='none'; }
  });

  // XLSX dÄ±ÅŸa aktar
  function exportXLS(filenameBase,rows){
    try{
      if(typeof XLSX!=='undefined' && XLSX.utils){
        const ws=XLSX.utils.aoa_to_sheet(rows);
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'Ziyaretler');
        const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
        const blob=new Blob([wbout],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=filenameBase+'.xlsx';
        a.click();
        URL.revokeObjectURL(a.href);
        return;
      }
      throw new Error('XLSX unavailable');
    }catch(e){
      let xmlH='<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
      let xml='<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"><Worksheet ss:Name="Ziyaretler"><Table>';
      rows.forEach(r=>{
        xml+='<Row>';
        r.forEach(c=>{
          let v=String(c??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          xml+=`<Cell><Data ss:Type="String">${v}</Data></Cell>`;
        });
        xml+='</Row>';
      });
      xml+='</Table></Worksheet></Workbook>';
      const blob=new Blob([xmlH+xml],{type:'application/vnd.ms-excel'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=filenameBase+'.xls';
      a.click();
      URL.revokeObjectURL(a.href);
    }
  }

  $('#exportBtn').addEventListener('click',()=>{
    const data=ensureVisitMeta();
    const rows=[[
      'No','ZiyaretTarihi','MÃ¼ÅŸteri','Yetkili','Ä°letiÅŸim','Modlar','Limanlar','Hacim',
      'Birim','Durum','Ã–ncelik','TakipTarihi','GÃ¼ncellemeTarihi','Versiyon','Etiketler','Teklif?','Notlar'
    ]].concat(
      data.map(d=>{
        const base = sanitizeNotes(d.baseNote ?? d.notes ?? '');
        let full = base;
        if(d.updateNote){
          const updDate = d.updatedAt ? new Date(d.updatedAt).toLocaleDateString('tr-TR') : '';
          full += '\n\nGÃ¼ncelleme Tarihi: '+updDate+'\n'+sanitizeNotes(d.updateNote);
        }
        return [
          d.id||'',
          niceDate(d.visitDate),
          d.name,
          d.contact||'',
          d.phone||'',
          (d.modes||[]).join('/'),
          (d.ports||[]).join(' | '),
          d.volume||'',
          d.volUnit||'',
          d.status||'',
          d.priority||'',
          niceDate(d.followDate)||'',
          niceDate(d.updatedAt)||'',
          (typeof d.ver==='number' ? 'v'+d.ver : ''),
          (d.tags||[]).join(' | '),
          d.needQuote?'Evet':'HayÄ±r',
          full
        ];
      })
    );
    exportXLS('ziyaretler_'+new Date().toISOString().slice(0,10),rows);
  });

  // PDF
  function showVisitPDF(v){
    if(!window.jspdf || !window.jspdf.jsPDF){
      alert('PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi.');
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF({unit:'pt',format:'a4'});

    const cw=1200, ch=1700;
    const c=document.createElement('canvas');
    c.width=cw; c.height=ch;
    const ctx=c.getContext('2d');
    ctx.fillStyle='#fff';
    ctx.fillRect(0,0,cw,ch);
    ctx.fillStyle='#111827';

    function wrapText(text,x,y,maxW,lh){
      text=sanitizeNotes(text);
      const words=text.split(/\s+/);
      let line='';
      for(const w of words){
        const test=line? line+' '+w : w;
        if(ctx.measureText(test).width>maxW && line){
          ctx.fillText(line,x,y);
          y+=lh;
          line=w;
        }else{
          line=test;
        }
      }
      if(line){
        ctx.fillText(line,x,y);
        y+=lh;
      }
      return y;
    }

    let x=140, y=80, lh=26, maxW=cw-180;

    const logo=load(STORAGE.logo,'');
    const img=new Image();
    img.onload=()=>{ try{ ctx.drawImage(img,60,50,60,60);}catch(e){} draw(); push(); };
    img.onerror=()=>{ draw(); push(); };
    img.src=logo||'';

    function draw(){
      ctx.font='bold 34px Arial, Helvetica, sans-serif';
      ctx.fillText('Mansfield Ziyaret Notu', x, y);
      y+=42;
      ctx.font='16px Arial, Helvetica, sans-serif';

      y=wrapText('No: '+(v.id||'-'),x,y,maxW,lh);
      y=wrapText('MÃ¼ÅŸteri: '+(v.name||'-'),x,y,maxW,lh);
      y=wrapText('Yetkili: '+(v.contact||'-'),x,y,maxW,lh);
      y=wrapText('Ä°letiÅŸim: '+(v.phone||'-'),x,y,maxW,lh);
      y=wrapText('Ziyaret Tarihi: '+(v.visitDate?new Date(v.visitDate).toLocaleDateString('tr-TR'):'-'),x,y,maxW,lh);

      const verStr = (typeof v.ver==='number' ? 'v'+v.ver : '');
      const updStr = v.updatedAt ? new Date(v.updatedAt).toLocaleDateString('tr-TR') : '';
      if(verStr || updStr){
        y=wrapText('GÃ¼ncelleme: '+[verStr,updStr].filter(Boolean).join(' â€” '),x,y,maxW,lh);
      }

      y=wrapText('Durum/Ã–ncelik: '+(v.status||'-')+' / '+(v.priority||'-'),x,y,maxW,lh);
      y=wrapText('Mod: '+((v.modes||[]).join('/')||'-'),x,y,maxW,lh);

      ctx.font='bold 18px Arial, Helvetica, sans-serif';
      ctx.fillText('Limanlar', x, y+8);
      y+=8+lh;
      ctx.font='16px Arial, Helvetica, sans-serif';
      y=wrapText((v.ports||[]).join(' | ')||'-',x,y,maxW,lh);

      ctx.font='bold 18px Arial, Helvetica, sans-serif';
      ctx.fillText('Notlar', x, y+8);
      y+=8+lh;
      ctx.font='16px Arial, Helvetica, sans-serif';
      const baseNote = v.baseNote ?? v.notes ?? '-';
      y=wrapText(baseNote||'-',x,y,maxW,lh);

      if(v.updateNote){
        const updDateStr = v.updatedAt ? new Date(v.updatedAt).toLocaleDateString('tr-TR') : '-';
        ctx.font='bold 18px Arial, Helvetica, sans-serif';
        ctx.fillText('GÃ¼ncelleme Tarihi: '+updDateStr, x, y+8);
        y+=8+lh;
        ctx.font='16px Arial, Helvetica, sans-serif';
        y=wrapText(v.updateNote,x,y,maxW,lh);
      }
    }

    function push(){
      const data=c.toDataURL('image/png');
      doc.addImage(data,'PNG',0,0,595,842);
      const blob=doc.output('blob');
      const url=URL.createObjectURL(blob);
      window.open(url,'_blank');
    }
  }

  // ilk Ã§izimler
  $('#year').textContent=new Date().getFullYear();
  
  renderLinks();
  async function syncFromSupabase() {
  try {
    const { data, error } = await supabase
      .from('visits')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) throw error;
    if (data && data.length) {
      console.log("Supabase verileri yÃ¼klendi:", data.length);
      save(STORAGE.visits, data.map(d => ({
        id: d.id,
        name: d.name,
        contact: d.contact,
        phone: d.phone,
        modes: d.modes || [],
        status: d.status,
        priority: d.priority,
        ports: d.ports || [],
        volume: d.volume,
        volUnit: d.vol_unit,
        visitDate: d.visit_date,
        followDate: d.follow_date,
        notes: d.notes,
        baseNote: d.notes,
        updateNote: "",
        ver: 1,
      })));
    }
  } catch (err) {
    console.error("Supabase sync hatasÄ±:", err);
  }
}

// Sayfa yÃ¼klenirken Ã§aÄŸÄ±r:
await syncFromSupabase();
renderVisits();
renderCustomerLinks();

  renderVisits();
  renderCustomerLinks();
</script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://grqklcgxwmboedacobld.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdycWtsY2d4d21ib2VkYWNvYmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjc0NTUsImV4cCI6MjA3ODYwMzQ1NX0.8kUPsW6OtEZb-Dj0V83c0FcbhNyCnrbEZ3g6b_0dseo'; // anon public key
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadVisitsFromDB() {
    const { data, error } = await supabase
      .from('visits')
      .select('*')
      .order('created_at', { ascending: false });
    if (error) console.error(error);
    else console.log('DB verileri:', data);
    return data;
  }

  async function saveVisitToDB(visit) {
    const { data, error } = await supabase
      .from('visits')
      .insert([visit]);
    if (error) console.error('Ekleme hatasÄ±:', error);
    else console.log('Veri eklendi:', data);
  }

  // Ã–rnek kullanÄ±m:
  // loadVisitsFromDB();
  // saveVisitToDB({ name: 'ABC Lojistik', status: 'Yeni', notes: 'Ä°lk ziyaret' });
</script>

</body>
</html>




